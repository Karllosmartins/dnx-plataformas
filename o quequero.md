create table public.agentes_ia (
  id bigserial not null,
  created_at timestamp without time zone null default now(),
  agente_id text null,
  nome text null,
  funcao text null,
  prompt text null,
  estagio text null,
  user_id bigint null,
  constraint agentes_ia_pkey primary key (id),
  constraint agentes_ia_user_id_fkey foreign KEY (user_id) references users (id)
) TABLESPACE pg_default;

create table public.instancia_whtats (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  user_id bigint null,
  apikey text null,
  instancia text null,
  baseurl text null,
  waba_id text null,
  is_official_api boolean null default false,
  id_telefone text null,
  agante_id bigint null,
  constraint instancia_whtats_pkey primary key (id),
  constraint instancia_whtats_agante_id_fkey foreign KEY (agante_id) references agentes_ia (id),
  constraint instancia_whtats_user_id_fkey foreign KEY (user_id) references users (id)
) TABLESPACE pg_default;

create index IF not exists idx_instancia_waba_id on public.instancia_whtats using btree (waba_id) TABLESPACE pg_default;

create index IF not exists idx_instancia_official_api on public.instancia_whtats using btree (is_official_api) TABLESPACE pg_default;

create table public.leads (
  id bigserial not null,
  user_id bigint not null,
  created_at timestamp without time zone null default now(),
  remotejid text null default ''::text,
  response_id text null,
  atendimentofinalizado boolean null default false,
  conversation_log jsonb null default '[]'::jsonb,
  times_tamp text null default ''::text,
  tokens integer null default 0,
  user_lastinteraction text null,
  bot_lastinteraction text null,
  lead_id text null,
  contact_id text null,
  numero_formatado text null,
  email_usuario text null,
  task_id text null,
  site_usuario text null,
  link_meet text null,
  numero_follow text null,
  instance text null,
  nome_cliente text null,
  id_calendar text null,
  data_agendamento text null,
  hora_agendamento text null,
  "Agente_ID" text null default '1'::text,
  data_folowup_solicitado text null,
  folowup_solicitado boolean null default false,
  id_card timestamp with time zone null,
  existe_whatsapp boolean null,
  responsavel_encontrado boolean null default false,
  falando_com_responsavel boolean null default false,
  efetuar_disparo boolean null,
  nome_empresa text null,
  id_empresa text null,
  nome_campanha text null,
  cpf_cnpj character varying(14) null,
  telefone character varying(20) null,
  origem text null default 'WhatsApp'::text,
  status_limpa_nome text null default 'novo_lead'::text,
  valor_estimado_divida numeric(10, 2) null,
  valor_real_divida numeric(10, 2) null,
  valor_pago_consulta numeric(10, 2) null,
  valor_contrato numeric(10, 2) null,
  tempo_negativado text null,
  tipo_consulta_interesse text null,
  motivo_desqualificacao text null,
  data_pagamento timestamp with time zone null,
  link_pagamento text null,
  data_consulta timestamp with time zone null,
  orgaos_negativados text[] null,
  link_relatorio text null,
  observacoes_limpa_nome text null,
  data_escalacao timestamp with time zone null,
  vendedor_responsavel text null,
  data_fechamento timestamp with time zone null,
  data_ultima_atividade timestamp with time zone null default now(),
  updated_at timestamp with time zone null default now(),
  status_disparo text null,
  tipo_negocio_id bigint null,
  dados_personalizados jsonb null default '{}'::jsonb,
  status_generico character varying(50) null,
  constraint leads_pkey primary key (id),
  constraint leads_tipo_negocio_id_fkey foreign KEY (tipo_negocio_id) references tipos_negocio (id),
  constraint leads_user_id_fkey foreign KEY (user_id) references users (id) on delete CASCADE,
  constraint leads_status_limpa_nome_check check (
    (
      status_limpa_nome = any (
        array[
          'novo_lead'::text,
          'qualificacao'::text,
          'desqualificado'::text,
          'pagamento_consulta'::text,
          'nao_consta_divida'::text,
          'consta_divida'::text,
          'enviado_para_negociacao'::text,
          'cliente_fechado'::text
        ]
      )
    )
  ),
  constraint leads_valor_pago_consulta_check check (
    (
      valor_pago_consulta = any (array[(30)::numeric, (199)::numeric])
    )
  )
) TABLESPACE pg_default;

create index IF not exists idx_leads_user_id on public.leads using btree (user_id) TABLESPACE pg_default;

create index IF not exists idx_leads_cpf on public.leads using btree (cpf_cnpj) TABLESPACE pg_default;

create index IF not exists idx_leads_telefone on public.leads using btree (telefone) TABLESPACE pg_default;

create index IF not exists idx_leads_numero_formatado on public.leads using btree (numero_formatado) TABLESPACE pg_default;

create index IF not exists idx_leads_status_limpa_nome on public.leads using btree (status_limpa_nome) TABLESPACE pg_default;

create index IF not exists idx_leads_nome_cliente on public.leads using btree (nome_cliente) TABLESPACE pg_default;

create index IF not exists idx_leads_instance on public.leads using btree (instance) TABLESPACE pg_default;

create index IF not exists idx_leads_data_atividade on public.leads using btree (data_ultima_atividade) TABLESPACE pg_default;

create index IF not exists idx_leads_tipo_negocio_id on public.leads using btree (tipo_negocio_id) TABLESPACE pg_default;

create index IF not exists idx_leads_dados_personalizados on public.leads using gin (dados_personalizados) TABLESPACE pg_default;

create index IF not exists idx_leads_status_generico on public.leads using btree (status_generico) TABLESPACE pg_default;

create index IF not exists idx_leads_user_tipo on public.leads using btree (user_id, tipo_negocio_id) TABLESPACE pg_default;

create trigger update_leads_updated_at BEFORE
update on leads for EACH row
execute FUNCTION update_updated_at_column ();

create table public.user_agent_vectorstore (
  id serial not null,
  user_id bigint not null,
  agent_id bigint not null,
  vectorstore_id text not null,
  is_active boolean not null default true,
  created_at timestamp with time zone null default CURRENT_TIMESTAMP,
  updated_at timestamp with time zone null default CURRENT_TIMESTAMP,
  constraint user_agent_vectorstore_pkey primary key (id),
  constraint unique_user_agent_vectorstore unique (user_id, agent_id, vectorstore_id),
  constraint user_agent_vectorstore_agent_id_fkey foreign KEY (agent_id) references agentes_ia (id),
  constraint user_agent_vectorstore_user_id_fkey foreign KEY (user_id) references users (id)
) TABLESPACE pg_default;

create index IF not exists idx_user_agent_vectorstore_vectorstore_id on public.user_agent_vectorstore using btree (vectorstore_id) TABLESPACE pg_default;

create index IF not exists idx_user_agent_vectorstore_user_id on public.user_agent_vectorstore using btree (user_id) TABLESPACE pg_default;

create index IF not exists idx_user_agent_vectorstore_active on public.user_agent_vectorstore using btree (is_active) TABLESPACE pg_default;

create index IF not exists idx_user_agent_vectorstore_user_active on public.user_agent_vectorstore using btree (user_id, is_active) TABLESPACE pg_default;

create index IF not exists idx_user_agent_vectorstore_agent_id on public.user_agent_vectorstore using btree (agent_id) TABLESPACE pg_default;

create table public.user_tools (
  id serial not null,
  user_id integer not null,
  tool_id integer not null,
  agente_id bigint null,
  is_active boolean null default true,
  created_at timestamp without time zone null default CURRENT_TIMESTAMP,
  constraint user_tools_pkey primary key (id),
  constraint user_tools_agente_id_fkey foreign KEY (agente_id) references agentes_ia (id),
  constraint user_tools_tool_id_fkey foreign KEY (tool_id) references tools (id),
  constraint user_tools_user_id_fkey foreign KEY (user_id) references users (id)
) TABLESPACE pg_default;